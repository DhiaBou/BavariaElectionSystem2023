WITH TotalVotes AS (
    SELECT
        COUNT(*) AS TotalSecondVotes
    FROM
        Stimmzettel
),
PartyVotes AS (
    SELECT
        p."ParteiID",
        COUNT(*) AS "Votes"
    FROM
        Stimmzettel s
    JOIN
        Kandidaten k ON s."Zweitstimme" = k."KandidatID"
    JOIN
        Parteien p ON k."ParteiID" = p."ParteiID"
    GROUP BY
        p."ParteiID"
),
ValidParties AS (
    SELECT
        pv."ParteiID",
        pv."Votes"
    FROM
        PartyVotes pv
    WHERE
        (pv."Votes" / (SELECT TotalSecondVotes FROM TotalVotes)) * 100 >= 5 -- Assuming a 5% threshold
)
SELECT
    p."ParteiID",
    COUNT(*) AS Votes
FROM
    Stimmzettel s
JOIN
    Kandidaten k ON s."Zweitstimme" = k."KandidatID"
JOIN
    Parteien p ON k."ParteiID" = p."ParteiID"
GROUP BY
    p."ParteiID"
HAVING
    (COUNT(*) / (SELECT COUNT(*) FROM Stimmzettel)) * 100 >= 5 -- Assuming a 5% threshold

